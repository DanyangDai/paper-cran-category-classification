---
title: "Processing Cranlog data"
author: "Danyang Dai"
date: "13/08/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(cranlogs)
library(purrr)
```


```{r process, cache=TRUE}
# function that process the cranlog raw data
# count the number of daily downloads for each unique country, ip_id, package 


process_data <- function(file) {
  read_csv(file) %>% 
    filter(!is.na(package)) %>% 
    count(country, ip_id, package, version, date) %>% 
    saveRDS(file.path(dirname(file), "..", "processed",str_replace(basename(file), "[.]csv[.]gz", ".rds")))
}

# first process all the data, done 

lapply(csv_files,process_data)
```


Things to check for the processed data: 

- does the processed data consistant with cranlog data? Need to check the daily total downloads for each package and compare it with cranlog 

- find the daily unique download for each package and compare it with the total download 

- find the daily unique download for each package with different version and find which version is most popular 



```{r}
# use 2012 as an example, if it works, apply to all data 

# processed data consistant with cranlog data?

# step 1 load in the processed data 

rds_files <- list.files(path = "../data/processed", pattern=".rds$",
                        full.names = TRUE) 

processed_2012 <-rds_files[grep(rds_files, pattern="2012")] %>% 
                  map(readRDS) %>% 
                  bind_rows()

# step 2 get the daily total download for each package from the processed data

total_processed_2012 <- processed_2012 %>%  
  group_by(package,date) %>% 
  summarise(total = sum(n))

# checking the total number of r packages download on the 2012-10-09 
# problem, can only get the package that we have from the cranlog raw data file, cannnot just get the total daily downloads for each package 
# problem, when try to use the cran_downloads for all the packges, API limitation applys 

cran_log_20121009 <-cran_downloads(packages = c(`2012-10-09`$package), from = "2012-10-09", to = "2012-10-09")
cran_log_20121009 <- as_tibble(cran_log_20121009)

r_pkg_20121009 <- processed_2012 %>% 
  group_by(date) %>% 
  filter(date == "2012-10-09") %>% 
  summarise(total = sum(n))

# compare with cranlog download data 
cran_downloads(from = "2012-10-09", to = "2012-10-09")

# only one of the date does not match
total_processed_2012 %>% 
  group_by(date) %>% 
  summarise(total = sum(total)) %>% 
  left_join(
    cran_downloads(from = min(dates), to = max(dates)),
    by = "date"
  ) %>% 
  count(count == total)



total_processed_2012 %>% 
  group_by(date) %>% 
  summarise(total = sum(total)) %>% 
  left_join(
    cran_downloads(from = min(dates), to = max(dates)),
    by = "date"
  ) 
```

There are in total `r r_pkg_20121009` r packaged downloaded from the cranlog raw data file. From the `cranlog` package, using the function `cran_downloads`, there are in total `cran_downloads(from = "2012-10-09", to = "2012-10-09")` r packages downloaded. The reason that there are less r packages download from the `cranlog` package is that in the raw data file, it contains NA value. After removing the NA value in the raw data file. The number adds up. 

The date for the 2012 is not matching. The file date and the actuall date is not consistant. After remove all the NA in the processed data, most of the dates are consistent with the cranlog package. However, the data fro `2012-12-26` has a huge gap between the cranlog file raw data and the `cranlog` package data. 


```{r}
# checking the package downloads for each year 

# r packages download from cranlog package 
cran_dl <- map_dfr(xfun::sans_ext(basename(rds_files)),
    function(date) {
      date <- as.Date(date)
      #pkg <- unique(total_processed_2012$package[total_processed_2012$date == date])
      
      cran_downloads(
          from = format(date, "%Y-%m-%d"),
          to = format(date, "%Y-%m-%d")
      )
      
    }
)

#dates <- as.Date(total_processed_2012$date)

processed_2013 <-rds_files[grep(rds_files, pattern="2013")] %>% 
                  map(readRDS) %>% 
                  bind_rows()

total_processed_2013 <- processed_2013 %>%  
  group_by(package,date) %>% 
  summarise(total = sum(n))


total_processed_2013 %>% 
  group_by(date) %>% 
  summarise(total = sum(total)) %>% 
  left_join(
   cran_dl,
    by = "date"
  ) %>% 
  count(count == total)



```

```{r}
`2012-10-09`$packages

cran_log_20121009 <-cran_downloads(packages = c(`2012-10-09`$package), from = "2012-10-09", to = "2012-10-09")


cran_log_20121009 %>% group_by(package) %>% 
  summarise(total = sum(count))
  
total <- `2012-10-09` %>% 
  group_by(package) %>% 
  summarise(total = sum(n))

total$total - cran_log_20121009$total

%>% 
  mutate(cranlog = cran_log_20121009$count) 
  
  filter(package == "ggplot2") %>% 
  mutate(id = paste(country,ip_id)) %>% 
  pull(id) %>% 
  unique() %>% 
  length()

```


```{r}


# second, check the package downloads against with cranlog 
## read in the data readRDS("path + file name"), the path and file name is the csv_file 

rds_files <- list.files(path = "data/processed", pattern=".rds$",
                        full.names = TRUE) 

## find the total number of downloads for each package for the day 
processed_2012 <- readRDS(rds_files[grep(rds_files, pattern="2012")], id = "file")



cran_log_20121014 <-cran_downloads(package = c(`2012-10-14`$package),from = "2012-10-14", to = "2012-10-14")

total_20121014 <- `2012-10-14` %>% 
  group_by(package) %>% 
  summarise(total = sum(n)) 

cran_log_20121014$count - total_20121014$total
# calculate the differences 


```


