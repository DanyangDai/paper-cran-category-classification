---
title: "Untitled"
author: "Danyang Dai"
date: "28/03/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r}
# load in packages 

library(tidyverse)
library(lubridate)
library(cranlogs)
library(DBI)

```


```{r}
# connect to the data base
con <- dbConnect(
  RPostgres::Postgres(),
  host = "db.mitchelloharawild.com",
  dbname = "cranlogs",
  user = "guest",
  password = "JNoGzAc9V5yxdsU9"
)

DBI::dbListTables(con)
#> [1] "cran_logs"
cran_logs <- tbl(con, "cran_logs")
```

```{r}
# duplicated downloads over time 

daily_download <- cran_logs %>% 
  group_by(file_date) %>% 
  summarise(download = sum(n_total),unique = sum(n_unique)) %>% 
  collect()


daily_download <- daily_download %>% 
  mutate(difference = download - unique) %>% 
  mutate(download = as.integer(download)) %>% 
  mutate(unique = as.integer(unique))


daily_download %>% 
  ggplot(aes(x = file_date)) +
  geom_line(aes(y = download), color = "red") + 
  geom_line(aes(y = unique), color = "blue") + 
  geom_line(aes(y = difference), color = "green")
```

```{r}
download_2021 <- cran_logs %>% 
  filter(file_date >= "2021-01-01" & file_date <= "2021-12-31") %>%
  group_by(file_date,package) %>% 
  summarise(download = sum(n_total),unique = sum(n_unique)) %>% 
  collect()


total_2021_pkg <-download_2021 %>% 
  group_by(package) %>% 
  summarise(annual_total = sum(download), annual_unique = sum(unique)) %>% 
  mutate(annual_total = as.integer(annual_total),
         annual_unique = as.integer(annual_unique))

total_2021_pkg <- total_2021_pkg %>% 
  mutate(diff = annual_total - annual_unique) %>% 
  mutate(precentage = (annual_unique/annual_total)*100)
```


```{r}
# ggplot has the most duplicated downloads in 2021
total_2021_pkg <- total_2021_pkg %>% 
  arrange(-annual_total) %>% 
  mutate(rank_total = rep(1:nrow(total_2021_pkg)))

total_2021_pkg <- total_2021_pkg %>% 
  arrange(-annual_unique) %>% 
  mutate(rank_unique = rep(1:nrow(total_2021_pkg))) %>% 
  mutate(rank_diff = rank_total - rank_unique)
```

```{r}
total_2021_pkg %>% 
  ggplot(aes(x=precentage))+
  geom_histogram()
```


```{r}
download_2020 <- cran_logs %>% 
  filter(file_date >= "2020-01-01" & file_date <= "2020-12-31") %>%
  group_by(file_date,package) %>% 
  summarise(download = sum(n_total),unique = sum(n_unique)) %>% 
  collect()

download_2019 <- cran_logs %>% 
  filter(file_date >= "2019-01-01" & file_date <= "2019-12-31") %>%
  group_by(file_date,package) %>% 
  summarise(download = sum(n_total),unique = sum(n_unique)) %>% 
  collect()

download_2018 <- cran_logs %>% 
  filter(file_date >= "2018-01-01" & file_date <= "2018-12-31") %>%
  group_by(file_date,package) %>% 
  summarise(download = sum(n_total),unique = sum(n_unique)) %>% 
  collect()


download_2017 <- cran_logs %>% 
  filter(file_date >= "2017-01-01" & file_date <= "2017-12-31") %>%
  group_by(file_date,package) %>% 
  summarise(download = sum(n_total),unique = sum(n_unique)) %>% 
  collect()

download_2016 <- cran_logs %>% 
  filter(file_date >= "2016-01-01" & file_date <= "2016-12-31") %>%
  group_by(file_date,package) %>% 
  summarise(download = sum(n_total),unique = sum(n_unique)) %>% 
  collect()

download_2015 <- cran_logs %>% 
  filter(file_date >= "2015-01-01" & file_date <= "2015-12-31") %>%
  group_by(file_date,package) %>% 
  summarise(download = sum(n_total),unique = sum(n_unique)) %>% 
  collect()

download_2014 <- cran_logs %>% 
  filter(file_date >= "2014-01-01" & file_date <= "2014-12-31") %>%
  group_by(file_date,package) %>% 
  summarise(download = sum(n_total),unique = sum(n_unique)) %>% 
  collect()

download_2013 <- cran_logs %>% 
  filter(file_date >= "2013-01-01" & file_date <= "2013-12-31") %>%
  group_by(file_date,package) %>% 
  summarise(download = sum(n_total),unique = sum(n_unique)) %>% 
  collect()

```


```{r}
total_2020_pkg <-download_2020 %>% 
  group_by(package) %>% 
  summarise(annual_total = sum(download), annual_unique = sum(unique)) %>% 
  mutate(annual_total = as.integer(annual_total),
         annual_unique = as.integer(annual_unique))

total_2020_pkg <- total_2020_pkg %>% 
  mutate(diff = annual_total - annual_unique) %>% 
  mutate(precentage = (annual_unique/annual_total)*100)

total_2020_pkg <- total_2020_pkg %>% 
  arrange(-annual_total) %>% 
  mutate(rank_total = rep(1:nrow(total_2020_pkg)))

total_2020_pkg <- total_2020_pkg %>% 
  arrange(-annual_unique) %>% 
  mutate(rank_unique = rep(1:nrow(total_2020_pkg))) %>% 
  mutate(rank_diff = rank_total - rank_unique)


```

```{r}
total_2019_pkg <-download_2019 %>% 
  group_by(package) %>% 
  summarise(annual_total = sum(download), annual_unique = sum(unique)) %>% 
  mutate(annual_total = as.integer(annual_total),
         annual_unique = as.integer(annual_unique))

total_2019_pkg <- total_2019_pkg %>% 
  mutate(diff = annual_total - annual_unique) %>% 
  mutate(precentage = (annual_unique/annual_total)*100)

total_2019_pkg <- total_2019_pkg %>% 
  arrange(-annual_total) %>% 
  mutate(rank_total = rep(1:nrow(total_2019_pkg)))

total_2019_pkg <- total_2019_pkg %>% 
  arrange(-annual_unique) %>% 
  mutate(rank_unique = rep(1:nrow(total_2019_pkg))) %>% 
  mutate(rank_diff = rank_total - rank_unique)

```


```{r}
total_2018_pkg <-download_2018 %>% 
  group_by(package) %>% 
  summarise(annual_total = sum(download), annual_unique = sum(unique)) %>% 
  mutate(annual_total = as.integer(annual_total),
         annual_unique = as.integer(annual_unique))

total_2018_pkg <- total_2018_pkg %>% 
  mutate(diff = annual_total - annual_unique) %>% 
  mutate(precentage = (annual_unique/annual_total)*100)

total_2018_pkg <- total_2018_pkg %>% 
  arrange(-annual_total) %>% 
  mutate(rank_total = rep(1:nrow(total_2018_pkg)))

total_2018_pkg <- total_2018_pkg %>% 
  arrange(-annual_unique) %>% 
  mutate(rank_unique = rep(1:nrow(total_2018_pkg))) %>% 
  mutate(rank_diff = rank_total - rank_unique)

```

```{r}
total_2017_pkg <-download_2017 %>% 
  group_by(package) %>% 
  summarise(annual_total = sum(download), annual_unique = sum(unique)) %>% 
  mutate(annual_total = as.integer(annual_total),
         annual_unique = as.integer(annual_unique))

total_2017_pkg <- total_2017_pkg %>% 
  mutate(diff = annual_total - annual_unique) %>% 
  mutate(precentage = (annual_unique/annual_total)*100)

total_2017_pkg <- total_2017_pkg %>% 
  arrange(-annual_total) %>% 
  mutate(rank_total = rep(1:nrow(total_2017_pkg)))

total_2017_pkg <- total_2017_pkg %>% 
  arrange(-annual_unique) %>% 
  mutate(rank_unique = rep(1:nrow(total_2017_pkg))) %>% 
  mutate(rank_diff = rank_total - rank_unique)

```

```{r}
total_2016_pkg <-download_2016 %>% 
  group_by(package) %>% 
  summarise(annual_total = sum(download), annual_unique = sum(unique)) %>% 
  mutate(annual_total = as.integer(annual_total),
         annual_unique = as.integer(annual_unique))

total_2016_pkg <- total_2016_pkg %>% 
  mutate(diff = annual_total - annual_unique) %>% 
  mutate(precentage = (annual_unique/annual_total)*100)

total_2016_pkg <- total_2016_pkg %>% 
  arrange(-annual_total) %>% 
  mutate(rank_total = rep(1:nrow(total_2016_pkg)))

total_2016_pkg <- total_2016_pkg %>% 
  arrange(-annual_unique) %>% 
  mutate(rank_unique = rep(1:nrow(total_2016_pkg))) %>% 
  mutate(rank_diff = rank_total - rank_unique)

```


```{r}
total_2015_pkg <-download_2015 %>% 
  group_by(package) %>% 
  summarise(annual_total = sum(download), annual_unique = sum(unique)) %>% 
  mutate(annual_total = as.integer(annual_total),
         annual_unique = as.integer(annual_unique))

total_2015_pkg <- total_2015_pkg %>% 
  mutate(diff = annual_total - annual_unique) %>% 
  mutate(precentage = (annual_unique/annual_total)*100)

total_2015_pkg <- total_2015_pkg %>% 
  arrange(-annual_total) %>% 
  mutate(rank_total = rep(1:nrow(total_2015_pkg)))

total_2015_pkg <- total_2015_pkg %>% 
  arrange(-annual_unique) %>% 
  mutate(rank_unique = rep(1:nrow(total_2015_pkg))) %>% 
  mutate(rank_diff = rank_total - rank_unique)

```


```{r}
total_2014_pkg <-download_2014 %>% 
  group_by(package) %>% 
  summarise(annual_total = sum(download), annual_unique = sum(unique)) %>% 
  mutate(annual_total = as.integer(annual_total),
         annual_unique = as.integer(annual_unique))

total_2014_pkg <- total_2014_pkg %>% 
  mutate(diff = annual_total - annual_unique) %>% 
  mutate(precentage = (annual_unique/annual_total)*100)

total_2014_pkg <- total_2014_pkg %>% 
  arrange(-annual_total) %>% 
  mutate(rank_total = rep(1:nrow(total_2014_pkg)))

total_2014_pkg <- total_2014_pkg %>% 
  arrange(-annual_unique) %>% 
  mutate(rank_unique = rep(1:nrow(total_2014_pkg))) %>% 
  mutate(rank_diff = rank_total - rank_unique)

```

```{r}
total_2013_pkg <-download_2013 %>% 
  group_by(package) %>% 
  summarise(annual_total = sum(download), annual_unique = sum(unique)) %>% 
  mutate(annual_total = as.integer(annual_total),
         annual_unique = as.integer(annual_unique))

total_2013_pkg <- total_2013_pkg %>% 
  mutate(diff = annual_total - annual_unique) %>% 
  mutate(precentage = (annual_unique/annual_total)*100)

total_2013_pkg <- total_2013_pkg %>% 
  arrange(-annual_total) %>% 
  mutate(rank_total = rep(1:nrow(total_2013_pkg)))

total_2013_pkg <- total_2013_pkg %>% 
  arrange(-annual_unique) %>% 
  mutate(rank_unique = rep(1:nrow(total_2013_pkg))) %>% 
  mutate(rank_diff = rank_total - rank_unique)
```


```{r}
total_year <- bind_rows(
  `2013`= total_2013_pkg,
  `2014`= total_2014_pkg,
  `2015`= total_2015_pkg,
  `2016`= total_2016_pkg,
  `2017`= total_2017_pkg,
  `2018`= total_2018_pkg,
  `2019`= total_2019_pkg,
  `2020`= total_2020_pkg,
  `2021`= total_2021_pkg,
  .id = "year"
)
```

```{r}
total_year %>% ggplot(aes(y = precentage)) +
  geom_boxplot(aes(x = year, color = year))
```

```{r}
total_year %>% 
  filter(rank_total <= 10) %>% 
  ggplot(aes(y = precentage, x = year, color = package)) + 
  geom_point()
```

