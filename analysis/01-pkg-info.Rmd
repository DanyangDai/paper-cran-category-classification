---
title: Extracting package information 
output: html_document
---


```{r all_pkgs}
library(tidyverse)
library(lubridate)
library(rvest)
library(glue)
library(dplyr)
library(purrr)
library(ggplot2)


```

```{r}
url <- "http://cran.rstudio.com/web/packages/packages.rds"
db <- readRDS(url(url)) %>% 
  as.data.frame()%>% 
  mutate(Description = str_replace_all(Description, "\n", " "),
         Description = str_squish(Description),
         Title = str_replace_all(Title, "\n", " "))
```


```{r remove-same-authors}
n_pkgs <-nrow(db)
author<-distinct(db,Author,.keep_all= TRUE)
nrow(author)
```


An alternative way to get the CRAN R-package names.
```{r cran-names}
library(available)
cran_names <- rownames(available:::available_packages(repos = available:::default_cran_repos))
```



```{r package-updates}
library(pkgsearch)
updates <-map_dfr(cran_names[1:1000], cran_package_history)
updates_2 <- map_dfr(cran_names[1001:3000], cran_package_history)
updates_3 <- map_dfr(cran_names[3001:4000], possibly(cran_package_history, NULL))
updates_4 <- map_dfr(cran_names[4001:6000], possibly(cran_package_history, NULL))
updates_5 <- map_dfr(cran_names[6001:8000], possibly(cran_package_history, NULL))
updates_6 <- map_dfr(cran_names[8001:10000], possibly(cran_package_history, NULL))
updates_7 <- map_dfr(cran_names[10001:12000], possibly(cran_package_history, NULL))
updates_8 <- map_dfr(cran_names[12001:14000], possibly(cran_package_history, NULL))
updates_9 <- map_dfr(cran_names[14000:17828], possibly(cran_package_history, NULL))

```


```{r select_pkg_ver_date}
select_pkg_ver_date <- function(x) { 
      x %>%       
        select(Package,Version,date)
}
updates_list <- 
updates_select <- map_dfr(updates_list, select_pkg_ver_date)
```

```{r}
updates_select <- updates_select %>% 
  mutate(Date=as.Date(updates_select$date))
```
```{r}
first_release <- updates_select %>% 
  group_by(Package) %>% 
  filter(Date == min(Date))

first_release %>%
  group_by(Date) %>%
  summarise(n = n_distinct(Package)) %>%
  ggplot()  + geom_line(aes(Date, n))

#seasonality plot 
# trend - STL/ MA to smooth out the trend 
```

```{r}
first_release %>%
  filter(Date >= as.Date('1998-01-01') & Date <= as.Date('2010-01-01')) %>% 
  group_by(Date) %>%
  summarise(n = n_distinct(Package)) %>% 
  ggplot()  + geom_point(aes(Date, n))
```

```{r}
first_release %>%
  filter(Date >= as.Date('2010-01-01') & Date <= as.Date('2022-01-01')) %>% 
  group_by(Date) %>%
  summarise(n = n_distinct(Package)) %>% 
  ggplot()  + geom_point(aes(Date, n))
```

To get the list of packages for a particular CRAN task view:

```{r ctv}
doe_pkgs <- ctv:::.get_pkgs_from_ctv_or_repos("ExperimentalDesign", 
                                              repos = "http://cran.rstudio.com/")[[1]]
survey_pkgs <- ctv:::.get_pkgs_from_ctv_or_repos("OfficialStatistics", 
                                              repos = "http://cran.rstudio.com/")[[1]]

```


```{r}
update_freq <- updates_select %>% 
  group_by(Package) %>% 
  arrange(Date) %>%
  mutate(diff = c(NA,diff(Date)))

update_avg <- update_freq %>% 
  select(Package,diff) %>% 
  na.omit() %>% 
  group_by(Package) %>%
  summarise(avg=mean(diff))

 updates_select%>% 
  filter(Package=="Ecdat")

summary(update_freq$diff)

```







How to get the package updates:

```{r pkg-updates}
pkg_url <- "https://cran.r-project.org/web/packages/{pkg}/index.html"
pkg_archive <- "https://cran.r-project.org/src/contrib/Archive/{pkg}/"

pkgs_of_interest <- doe_pkgs[1:4]
pkg_updates <- map(pkgs_of_interest, function(pkg) {
    last_update <- read_html(glue(pkg_url)) %>% 
      html_table() %>% 
      .[[1]] %>% 
      filter(X1=="Published:") %>% 
      pull(X2) %>% 
      ymd()
      
    archive_dates <- tryCatch({ 
        read_html(glue(pkg_archive)) %>% 
          html_table() %>%
          .[[1]] %>% 
          pull(`Last modified`) %>% 
          ymd_hm() %>% 
          na.omit() %>% 
          as.Date()
      }, error = function(e) {
        NULL
      })
    c(archive_dates, last_update)
  })
names(pkg_updates) <- pkgs_of_interest

updates <- unlist(pkg_updates) %>% 
  enframe("package", "update") %>% 
  # unlist converts date to integers
  mutate(update = as.Date(update, origin = "1970-01-01"),
         # need to get rid of the numbers appended to pkg names
         package = str_extract(package, paste0(pkgs_of_interest, collapse="|"))) 

updates
```

